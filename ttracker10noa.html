<!DOCTYPE html>
<html lang="en">
<head>
    <title>Alien Tech GPX Tracker: Ultra Accurate (Accelerometer Removed)</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-providers/leaflet-providers.css" />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@600&display=swap');
        :root {
            --alien-cyan: #00ffe7;
            --alien-blue: #0ff4;
            --alien-dark: #0f2027;
            --alien-mid: #2c5364;
            --alien-yellow: #ffeb3b;
            --alien-green: #00ff88;
            --alien-red: #ff4444;
        }
        body {
            margin:0; font-family:'Orbitron', 'Consolas', monospace;
            background:linear-gradient(135deg, var(--alien-dark) 0%, var(--alien-mid) 100%);
            color:#bafff5; letter-spacing:1.2px;
            overflow-x:hidden; min-height:100vh;
            position:relative;
        }
        body::before {
            content:''; position:fixed; top:0; left:0; width:100%; height:100%;
            background:radial-gradient(circle at 20% 80%, var(--alien-cyan)22, transparent 50%),
                       radial-gradient(circle at 80% 20%, var(--alien-blue)22, transparent 50%);
            pointer-events:none; z-index:-1; opacity:0.1;
            animation: alienAmbient 8s ease-in-out infinite alternate;
        }
        @keyframes alienAmbient {
            0% { opacity:0.05; transform:scale(0.8) rotate(0deg); }
            100% { opacity:0.15; transform:scale(1.2) rotate(5deg); }
        }
        .version-badge {
            position:absolute; top:10px; right:10px; z-index:1000;
            background:linear-gradient(135deg, var(--alien-cyan), var(--alien-green));
            color:#000; padding:6px 12px; border-radius:20px;
            font-size:12px; font-weight:800; letter-spacing:1px;
            box-shadow:0 0 20px var(--alien-cyan);
            animation: versionPulse 3s infinite;
        }
        @keyframes versionPulse {
            0%, 100% { box-shadow:0 0 20px var(--alien-cyan); }
            50% { box-shadow:0 0 40px var(--alien-cyan), 0 0 60px var(--alien-green); }
        }

        h3 {
            margin:0 0 8px 0; color:var(--alien-cyan);
            text-shadow:0 0 12px var(--alien-cyan), 0 0 4px #fff;
            font-weight:700; font-size:20px;
        }
        #map {
            height:70vh; min-height:220px; width:100vw;
            box-shadow:0 0 50px 15px var(--alien-cyan), 0 0 120px 25px var(--alien-blue), 0 0 0 5px var(--alien-blue) inset;
            border-radius:25px; margin-bottom:12px;
            animation: alienGlow 4s infinite alternate;
            position:relative; overflow:hidden;
        }
        @keyframes alienGlow {
            0% { box-shadow:0 0 50px 15px var(--alien-cyan), 0 0 120px 25px var(--alien-blue), 0 0 0 5px var(--alien-blue) inset; }
            100% { box-shadow:0 0 100px 30px var(--alien-cyan), 0 0 240px 50px var(--alien-blue), 0 0 0 10px var(--alien-cyan) inset; }
        }

        .panel {
            padding:20px 26px 12px 26px;
            background:rgba(0,30,40,0.92);
            border-radius:0 0 25px 25px;
            box-shadow:0 0 50px var(--alien-cyan) inset, 0 5px 30px rgba(0,255,231,0.3);
            margin-bottom:12px;
            position:relative; z-index:2;
            border:2px solid rgba(0,255,231,0.3);
        }

        .alien-btn, .export-btn, .waypoint-btn, .compass-btn, .maps-btn, select {
            background:linear-gradient(135deg, var(--alien-cyan), var(--alien-green) 70%, var(--alien-cyan));
            color:#101a1c; border:none; border-radius:12px; padding:12px 24px;
            font-size:16px; font-weight:700; cursor:pointer; margin:12px 10px 12px 0;
            box-shadow:0 0 15px var(--alien-cyan), 0 0 3px #fff inset;
            text-shadow:0 0 3px #000;
            transition:all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            outline:none; position:relative; overflow:hidden;
            font-family:inherit; letter-spacing:0.5px;
        }
        .alien-btn::before, .export-btn::before, .waypoint-btn::before, .compass-btn::before, .maps-btn::before {
            content:''; position:absolute; top:0; left:-100%; width:100%; height:100%;
            background:linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            transition:left 0.5s;
        }
        .alien-btn:hover::before, .export-btn:hover::before, .waypoint-btn:hover::before,
        .compass-btn:hover::before, .maps-btn:hover::before {
            left:100%;
        }

        .alien-btn:disabled {
            background:#333; color:#666; cursor:not-allowed;
            box-shadow:none; opacity:0.5;
        }
        .alien-btn:hover:not(:disabled), .export-btn:hover, .waypoint-btn:hover,
        .compass-btn:hover, .maps-btn:hover {
            background:linear-gradient(135deg, var(--alien-green), var(--alien-cyan) 70%, var(--alien-green));
            box-shadow:0 0 30px var(--alien-cyan), 0 0 60px var(--alien-green), 0 0 8px #fff inset;
            transform:scale(1.05) translateY(-2px);
        }

        .export-btn {
            background:linear-gradient(135deg, #00e0ff, var(--alien-cyan), #00b8ff);
        }
        .waypoint-btn {
            background:linear-gradient(135deg, var(--alien-yellow), #ffaa00, var(--alien-yellow));
            color:#1a1a1a;
        }
        .maps-btn {
            background:linear-gradient(135deg, #007aff, #5ac8fa, #007aff);
            color:#fff;
        }

        select {
            background:rgba(16,26,28,0.95); color:var(--alien-cyan);
            border:2px solid var(--alien-cyan);
            font-family:inherit; margin-left:10px; font-size:15px;
            border-radius:8px; padding:8px 12px;
            box-shadow:0 0 10px var(--alien-cyan);
        }
        select:focus {
            outline:none; box-shadow:0 0 20px var(--alien-cyan);
        }

        #distance, #accuracy, #coords, #gyroData, #baroData, #weatherInfo, #trackStats, #speed, #duration,
        #elevMin, #elevMax, #elevGain, #compassLabel, #batteryStatus {
            font-size:17px; margin-top:6px; color:#bafff5;
            text-shadow:0 0 3px var(--alien-blue);
            line-height:1.4;
        }

        .stats-grid {
            display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));
            gap:15px; margin-top:15px;
        }
        .stat-item {
            background:rgba(0,255,231,0.1); padding:10px 15px; border-radius:10px;
            border:1px solid rgba(0,255,231,0.3);
            text-align:center;
        }
        .stat-label {
            font-size:12px; opacity:0.8; margin-bottom:5px;
            text-transform:uppercase; letter-spacing:1px;
        }
        .stat-value {
            font-size:18px; font-weight:700; color:var(--alien-cyan);
            text-shadow:0 0 5px var(--alien-cyan);
        }

        .weather-panel {
            background:rgba(10,40,60,0.8); padding:15px 25px; margin:12px 0;
            border-radius:20px;
            box-shadow:0 0 25px var(--alien-cyan), 0 0 50px rgba(0,255,231,0.2);
            border:2px solid var(--alien-cyan);
            animation: alienWeather 3s infinite alternate;
            position:relative; overflow:hidden;
        }
        .weather-panel::before {
            content:''; position:absolute; top:0; left:-100%; width:100%; height:100%;
            background:linear-gradient(90deg, transparent, rgba(0,255,231,0.1), transparent);
            animation: weatherSweep 4s infinite;
        }
        @keyframes weatherSweep {
            0% { left:-100%; }
            100% { left:100%; }
        }
        @keyframes alienWeather {
            0% { box-shadow:0 0 25px var(--alien-cyan), 0 0 50px rgba(0,255,231,0.2); }
            100% { box-shadow:0 0 50px var(--alien-cyan), 0 0 100px rgba(0,255,231,0.4); }
        }

        .elev-panel {
            width: 100vw;
            background:rgba(0,20,40,0.85);
            box-shadow:0 0 30px var(--alien-cyan) inset, 0 5px 20px rgba(0,255,231,0.2);
            border-radius: 0 0 25px 25px; margin-top: 0; padding-bottom: 20px;
            margin-bottom:15px; border:2px solid rgba(0,255,231,0.2);
        }
        .elev-header {
            font-size: 22px; font-weight: 800; color:var(--alien-cyan);
            padding: 20px 26px 10px 26px;
            text-shadow:0 0 15px var(--alien-cyan);
            letter-spacing:2px; position:relative;
        }
        .elev-header::after {
            content:''; position:absolute; bottom:0; left:26px; right:26px; height:2px;
            background:linear-gradient(90deg, transparent, var(--alien-cyan), transparent);
        }

        .elev-info {
            display: flex; flex-wrap: wrap; gap: 25px; padding: 0 26px 12px 26px;
            font-size: 16px; color: #bafff5;
        }

        #elevCanvas {
            display: block; margin: 0 auto; background:rgba(0,255,255,0.05);
            border: 3px solid var(--alien-cyan); border-radius: 15px; margin-top: 12px;
            box-shadow:0 0 25px var(--alien-cyan) inset, 0 0 50px rgba(0,255,231,0.2);
            animation: alienPanel 3s infinite alternate;
        }
         @keyframes alienPanel {
            0% { box-shadow:0 0 25px var(--alien-cyan) inset, 0 0 50px rgba(0,255,231,0.2); }
            100% { box-shadow:0 0 50px var(--alien-cyan) inset, 0 0 100px rgba(0,255,231,0.4); }
        }

        .compass-panel {
            display:flex; flex-direction:column; align-items:center;
            justify-content:center; margin:25px 0;
            background:rgba(0,30,40,0.7); padding:20px; border-radius:20px;
            border:2px solid rgba(0,255,231,0.3);
        }
        #compassCanvas {
            background:rgba(0,255,255,0.02); border:3px solid var(--alien-cyan);
            border-radius:50%; margin:12px;
            box-shadow:0 0 30px var(--alien-cyan) inset, 0 0 60px rgba(0,255,231,0.3);
            animation: alienPanel 3s infinite alternate;
        }

        #alien-tip {
            color:var(--alien-yellow); font-size:15px; margin-top:10px;
            text-shadow:0 0 3px var(--alien-yellow);
            padding:10px; background:rgba(255,235,59,0.1); border-radius:8px;
            border:1px solid rgba(255,235,59,0.3);
        }

        .performance-indicator {
            position:fixed; top:50px; right:15px; z-index:1000;
            background:rgba(0,0,0,0.8); padding:8px 12px; border-radius:10px;
            font-size:12px; border:1px solid var(--alien-cyan);
            box-shadow:0 0 10px var(--alien-cyan);
        }

        @media (max-width: 600px) {
            .panel {padding:15px 8px;}
            .elev-header, .elev-info {
                padding: 15px 12px; font-size: 14px;
            }
            #elevCanvas {width: 95vw !important;}
            .stats-grid {grid-template-columns:1fr;}
            .alien-btn, .export-btn, .waypoint-btn, .compass-btn, .maps-btn {
                padding:10px 16px; font-size:14px; margin:8px 6px 8px 0;
            }
        }
    </style>
</head>
<body>
    <div class="version-badge">v4.0 ULTRA</div>
    <div class="performance-indicator" id="perfIndicator">FPS: -- | GPS: --</div>

    <div class="panel">
        <button class="alien-btn" id="startBtn">▶️ Start Tracking</button>
        <button class="alien-btn" id="stopBtn" disabled>⏹️ Stop Tracking</button>
        <button class="alien-btn" id="resetBtn">🔄 Reset</button>
        <button class="export-btn" id="exportBtn">📁 Export GPX</button>
        <button class="waypoint-btn" id="addWptBtn">📍 Add Waypoint</button>
        <button class="maps-btn" id="openAppleMapsBtn">🍎 Open in Apple Maps</button>

        <select id="mapStyle">
            <option value="CartoDB.Positron">CartoDB Positron (Apple-like)</option>
            <option value="CartoDB.DarkMatter">CartoDB Dark Matter</option>
            <option value="OpenStreetMap.Mapnik">OpenStreetMap (Standard)</option>
            <option value="OpenTopoMap">OpenTopoMap (Terrain)</option>
        </select>

        <div class="stats-grid">
            <div class="stat-item">
                <div class="stat-label">GPS Distance</div>
                <div class="stat-value" id="distance">0.00 ft</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">Accuracy</div>
                <div class="stat-value" id="accuracy">--</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">Speed</div>
                <div class="stat-value" id="speed">0.0 mph</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">Duration</div>
                <div class="stat-value" id="duration">00:00:00</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">Avg Speed</div>
                <div class="stat-value" id="avgSpeed">0.0 mph</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">Max Speed</div>
                <div class="stat-value" id="maxSpeed">0.0 mph</div>
            </div>
        </div>

        <div id="coords">📍 Coordinates: N/A</div>
        <div>🌀 Gyro: <span id="gyroData">x:0, y:0, z:0</span></div>
        <div>📊 Barometer: <span id="baroData">--</span></div>
        <div>⚡ Battery: <span id="batteryStatus">--</span></div>
        <div>⬆️ GPS Altitude: <span id="gpsAltitude">--</span></div>
        <div>📈 Vertical Speed: <span id="verticalSpeed">--</span></div>
        <div>🧭 COG: <span id="cog">--</span></div>
        <div id="alien-tip">
            👽 <strong>PRO TIP v4.0:</strong> Enable GPS, Wi-Fi & Motion sensors. Go outside and wait for accuracy to improve. New: Enhanced sensor fusion & Apple Maps integration!
        </div>
    </div>

    <div id="map"></div>

    <div class="weather-panel">
        <h3>🌤️ Live Weather Conditions</h3>
        <div id="weatherInfo">Loading advanced weather data...</div>
    </div>

    <div class="elev-panel">
        <div class="elev-header">⛰️ Enhanced Elevation Profile</div>
        <canvas id="elevCanvas" width="350" height="100"></canvas>
        <div class="elev-info">
            <span id="elevMin">Min: --</span>
            <span id="elevMax">Max: --</span>
            <span id="elevGain">Total Gain: --</span>
        </div>
    </div>

    <div class="compass-panel">
        <canvas id="compassCanvas" width="120" height="120"></canvas>
        <div id="compassLabel">🧭 Heading: 0° (Magnetic North)</div>
        <button class="compass-btn alien-btn" id="toggleNorthBtn">Switch to True North</button>
    </div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-providers/leaflet-providers.js"></script>
    <script>
        // --- V4.0 ENHANCED FEATURES ---
        let startTime = null, trackingDuration = 0, currentSpeed = 0, avgSpeed = 0, maxSpeed = 0;
        let frameCount = 0, lastFrameTime = Date.now(), currentFPS = 0;
        let lastKnownCoords = null; // Store last coordinates for vertical speed calculation
        let lastKnownAltitude = null;
        let lastAltitudeTimestamp = null;

        // Performance monitoring
        function updatePerformance() {
            frameCount++;
            const now = Date.now();
            if (now - lastFrameTime >= 1000) {
                currentFPS = Math.round(frameCount * 1000 / (now - lastFrameTime));
                frameCount = 0;
                lastFrameTime = now;

                const gpsStatus = watchId ? 'ACTIVE' : 'IDLE';
                document.getElementById('perfIndicator').textContent =
                    `FPS: ${currentFPS} | GPS: ${gpsStatus}`;
            }
            requestAnimationFrame(updatePerformance);
        }

        // Duration tracking
        function updateDuration() {
            if (startTime && watchId) {
                trackingDuration = Date.now() - startTime;
                const hours = Math.floor(trackingDuration / 3600000);
                const minutes = Math.floor((trackingDuration % 3600000) / 60000);
                const seconds = Math.floor((trackingDuration % 60000) / 1000);
                document.getElementById('duration').textContent =
                    `${hours.toString().padStart(2,'0')}:${minutes.toString().padStart(2,'0')}:${seconds.toString().padStart(2,'0')}`;

                if (totalDistance > 0 && trackingDuration > 0) {
                    avgSpeed = (totalDistance / 5280) / (trackingDuration / 3600000); // miles per hour
                    document.getElementById('avgSpeed').textContent = avgSpeed.toFixed(1) + ' mph';
                }
            }
        }
        setInterval(updateDuration, 1000); // Update duration every second

        // --- MAP LAYERS ---
        const mapLayers = {
            'CartoDB.Positron': L.tileLayer.provider('CartoDB.Positron'),
            'CartoDB.DarkMatter': L.tileLayer.provider('CartoDB.DarkMatter'),
            'OpenStreetMap.Mapnik': L.tileLayer.provider('OpenStreetMap.Mapnik'),
            'OpenTopoMap': L.tileLayer.provider('OpenTopoMap'),
        };

        let map, trailLine, totalDistance = 0, lastLatLng = null, watchId = null, marker = null,
            trailCoordinates = [], elevProfile = [], waypoints = [], lastGPSTime = 0;

        const MIN_DISTANCE = 2, MAX_DISTANCE = 50, GPS_AVG_WINDOW = 5, GPS_SMOOTH_ALPHA = 0.7, ACCURACY_THRESHOLD = 50;

        // --- Compass ---
        let compassHeading = 0, useTrueNorth = false, magDeclination = 0;
        const compassCanvas = document.getElementById('compassCanvas');
        const compassCtx = compassCanvas.getContext('2d');
        function handleOrientation(event) {
            let heading;
            if (event.webkitCompassHeading !== undefined) { // iOS specific for True North
                heading = event.webkitCompassHeading;
                // If using True North and it's webkitCompassHeading, no declination needed
                if (!useTrueNorth) { // If Magnetic North is desired, convert from True North
                    heading = (heading - magDeclination + 360) % 360;
                }
            } else if (event.absolute && event.alpha !== null) { // For other browsers, absolute alpha
                heading = 360 - event.alpha;
                if (useTrueNorth) { // If True North is desired, add declination
                    heading = (heading + magDeclination + 360) % 360;
                }
            } else if (event.alpha !== null) { // Non-absolute alpha (Magnetic North)
                heading = 360 - event.alpha;
                if (useTrueNorth) { // If True North is desired, add declination
                    heading = (heading + magDeclination + 360) % 360;
                }
            } else {
                heading = 0;
            }
            compassHeading = (heading + 360) % 360;
            drawCompass();
        }

        function drawCompass() {
            compassCtx.clearRect(0,0,120,120);
            compassCtx.beginPath(); compassCtx.arc(60,60,50,0,2*Math.PI);
            compassCtx.strokeStyle="#00ffe7"; compassCtx.lineWidth=4; compassCtx.shadowColor="#00ffe7"; compassCtx.shadowBlur=10; compassCtx.stroke(); compassCtx.shadowBlur=0;
            compassCtx.save(); compassCtx.translate(60,60);
            compassCtx.rotate((compassHeading)*Math.PI/180);
            compassCtx.beginPath(); compassCtx.moveTo(0,0); compassCtx.lineTo(0,-40);
            compassCtx.strokeStyle="#ffeb3b"; compassCtx.lineWidth=5; compassCtx.stroke();
            compassCtx.beginPath(); compassCtx.moveTo(0,0); compassCtx.lineTo(0,30);
            compassCtx.strokeStyle="#00ffe7"; compassCtx.lineWidth=3; compassCtx.stroke();
            compassCtx.restore();
            compassCtx.font="18px Orbitron, Arial"; compassCtx.fillStyle="#00ffe7";
            compassCtx.textAlign="center"; compassCtx.fillText("N",60,25);
            document.getElementById('compassLabel').textContent =
                `🧭 Heading: ${compassHeading.toFixed(0)}° (${useTrueNorth ? "True North":"Magnetic North"})`;
        }
        document.getElementById('toggleNorthBtn').onclick = function() {
            useTrueNorth = !useTrueNorth;
            this.textContent = useTrueNorth ? "Switch to Magnetic North" : "Switch to True North";
            drawCompass();
        };

        // --- Barometer ---
        let baroAvailable = false, baroAlt = null, baroAlt0 = null;
        function setupBarometer() {
            if ('Barometer' in window) {
                try {
                    let baro = new Barometer({frequency: 1});
                    baro.addEventListener('reading', () => {
                        let alt = 44330 * (1 - Math.pow(baro.pressure/1013.25, 1/5.255));
                        if (!baroAlt0) baroAlt0 = alt;
                        baroAlt = alt - baroAlt0;
                        document.getElementById('baroData').textContent = `Alt: ${baroAlt.toFixed(1)} m (${baro.pressure.toFixed(1)} hPa)`;
                        if (watchId) { elevProfile.push(baroAlt); drawElevationProfile(); }
                    });
                    baro.start();
                    baroAvailable = true;
                } catch (e) { document.getElementById('baroData').textContent = 'Not supported'; }
            } else {
                document.getElementById('baroData').textContent = 'Not supported';
            }
        }

        // --- Elevation Profile ---
        const elevCanvas = document.getElementById('elevCanvas');
        const elevCtx = elevCanvas.getContext('2d');
        function drawElevationProfile() {
            elevCtx.clearRect(0,0,elevCanvas.width,elevCanvas.height);
            if (!elevProfile.length) return;

            let min = Math.min(...elevProfile), max = Math.max(...elevProfile), gain = 0;
            for (let i=1;i<elevProfile.length;i++) {
                if (elevProfile[i] > elevProfile[i-1]) {
                    gain += elevProfile[i]-elevProfile[i-1];
                }
            }

            document.getElementById('elevMin').textContent = 'Min: '+min.toFixed(1)+' m';
            document.getElementById('elevMax').textContent = 'Max: '+max.toFixed(1)+' m';
            document.getElementById('elevGain').textContent = 'Total Gain: '+gain.toFixed(1)+' m';

            elevCtx.beginPath();
            const range = max - min + 0.01;
            for(let i=0;i<elevProfile.length;i++) {
                let x = i/(elevProfile.length-1)*(elevCanvas.width-20)+10;
                let y = elevCanvas.height-10-((elevProfile[i]-min)/range)*(elevCanvas.height-20);
                if (i===0) elevCtx.moveTo(x,y); else elevCtx.lineTo(x,y);
            }
            elevCtx.strokeStyle="#00ffe7"; elevCtx.lineWidth=3; elevCtx.shadowColor="#00ffe7"; elevCtx.shadowBlur=6; elevCtx.stroke(); elevCtx.shadowBlur = 0;
        }

        // --- Motion Permissions (Gyro/Orientation only) ---
        window.addEventListener('deviceorientationabsolute', handleOrientation, true);
        window.addEventListener('deviceorientation', handleOrientation, true);
        document.getElementById('startBtn').disabled = false;

        function handleMotion(event) {
            // Gyroscope data
            if (event.rotationRate) {
                let lastGyro = {x: event.rotationRate.alpha || 0, y: event.rotationRate.beta || 0, z: event.rotationRate.gamma || 0};
                document.getElementById('gyroData').textContent = `x:${lastGyro.x.toFixed(2)}, y:${lastGyro.y.toFixed(2)}, z:${lastGyro.z.toFixed(2)}`;
            }
        }

        // --- GPS Smoothing and Filtering ---
        let gpsBuffer = [];
        function smoothGPS(lat, lng) {
            gpsBuffer.push([lat, lng]);
            if (gpsBuffer.length > GPS_AVG_WINDOW) gpsBuffer.shift();
            let sumLat = 0, sumLng = 0, weight = 1, totalWeight = 0;
            for (let i = gpsBuffer.length-1; i >= 0; i--) {
                sumLat += gpsBuffer[i][0] * weight;
                sumLng += gpsBuffer[i][1] * weight;
                totalWeight += weight;
                weight *= GPS_SMOOTH_ALPHA;
            }
            return [sumLat/totalWeight, sumLng/totalWeight];
        }

        // --- WEATHER (wttr.in, no API key, CORS workaround via JSONP) ---
        const weatherInfo = document.getElementById('weatherInfo');
        let lastWeatherUpdateCoords = {lat: null, lon: null};
        const WEATHER_UPDATE_THRESHOLD_KM = 5;
        const WEATHER_UPDATE_INTERVAL_MS = 5 * 60 * 1000;
        let lastWeatherUpdateTime = 0;

        function fetchWeatherByCoords(lat, lon) {
            const now = Date.now();
            if (lastWeatherUpdateCoords.lat !== null && lastWeatherUpdateCoords.lon !== null) {
                const distanceMoved = getDistanceFromLatLng([lastWeatherUpdateCoords.lat, lastWeatherUpdateCoords.lon], [lat, lon]) / 1000;
                if (distanceMoved < WEATHER_UPDATE_THRESHOLD_KM && (now - lastWeatherUpdateTime < WEATHER_UPDATE_INTERVAL_MS)) {
                    return;
                }
            }

            const url = `https://wttr.in/${lat},${lon}?format=%t+%C+%h`;
            fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(url)}`)
                .then(response => response.json())
                .then(data => {
                    if (!data.contents) {
                        weatherInfo.innerHTML = "Weather unavailable.";
                        return;
                    }
                    weatherInfo.innerHTML = data.contents.replace(/\+/g,'') || "Weather unavailable.";
                    lastWeatherUpdateCoords = {lat, lon};
                    lastWeatherUpdateTime = now;
                })
                .catch(() => { weatherInfo.innerHTML = "Weather unavailable."; });
        }

        // --- Battery Status ---
        function setupBatteryStatus() {
            if ('getBattery' in navigator) {
                navigator.getBattery().then(function(battery) {
                    function updateBatteryStatus() {
                        document.getElementById('batteryStatus').textContent =
                            `${(battery.level * 100).toFixed(0)}% (${battery.charging ? 'Charging' : 'Discharging'})`;
                    }
                    battery.addEventListener('levelchange', updateBatteryStatus);
                    battery.addEventListener('chargingchange', updateBatteryStatus);
                    updateBatteryStatus();
                });
            } else {
                document.getElementById('batteryStatus').textContent = 'Not supported';
            }
        }

        // --- GPS Tracking ---
        document.getElementById('startBtn').onclick = function() {
            if (navigator.geolocation) {
                document.getElementById('startBtn').disabled = true;
                document.getElementById('stopBtn').disabled = false;
                totalDistance = 0;
                document.getElementById('distance').textContent = 'GPS Distance: 0.00 ft';
                currentSpeed = 0;
                avgSpeed = 0;
                maxSpeed = 0;
                document.getElementById('speed').textContent = '0.0 mph';
                document.getElementById('avgSpeed').textContent = '0.0 mph';
                document.getElementById('maxSpeed').textContent = '0.0 mph';
                document.getElementById('verticalSpeed').textContent = '--';
                document.getElementById('gpsAltitude').textContent = '--';
                document.getElementById('cog').textContent = '--';

                lastLatLng = null;
                trailCoordinates = [];
                elevProfile = [];
                waypoints = [];
                gpsBuffer = [];
                startTime = Date.now();
                trackingDuration = 0;
                lastKnownCoords = null;
                lastKnownAltitude = null;
                lastAltitudeTimestamp = null;

                lastWeatherUpdateCoords = {lat: null, lon: null};
                lastWeatherUpdateTime = 0;

                if (trailLine) { map.removeLayer(trailLine); trailLine = null; }
                if (marker) { map.removeLayer(marker); marker = null; }
                map.eachLayer(function(layer){
                    if(layer instanceof L.Marker && layer._icon && layer._icon.src && layer._icon.src.includes('684908.png')) map.removeLayer(layer);
                });

                watchId = navigator.geolocation.watchPosition(updateLocation, handleError, {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                });

                window.addEventListener('devicemotion', handleMotion);

            }
        };
        document.getElementById('stopBtn').onclick = function() {
            if (watchId !== null) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
                document.getElementById('startBtn').disabled = false;
                document.getElementById('stopBtn').disabled = true;
                alert('Tracking stopped.');

                window.removeEventListener('devicemotion', handleMotion);
            }
        };
        document.getElementById('resetBtn').onclick = function() {
            if (watchId !== null) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
                document.getElementById('startBtn').disabled = false;
                document.getElementById('stopBtn').disabled = true;
                window.removeEventListener('devicemotion', handleMotion);
            }

            if (trailLine) { map.removeLayer(trailLine); trailLine = null; }
            if (marker) { map.removeLayer(marker); marker = null; }
            totalDistance = 0;
            currentSpeed = 0;
            avgSpeed = 0;
            maxSpeed = 0;
            startTime = null;
            trackingDuration = 0;
            lastLatLng = null;
            trailCoordinates = [];
            elevProfile = [];
            waypoints = [];
            gpsBuffer = [];
            lastKnownCoords = null;
            lastKnownAltitude = null;
            lastAltitudeTimestamp = null;


            document.getElementById('distance').textContent = 'GPS Distance: 0.00 ft';
            document.getElementById('speed').textContent = '0.0 mph';
            document.getElementById('avgSpeed').textContent = '0.0 mph';
            document.getElementById('maxSpeed').textContent = '0.0 mph';
            document.getElementById('duration').textContent = '00:00:00';
            document.getElementById('coords').textContent = '📍 Coordinates: N/A';
            document.getElementById('accuracy').textContent = 'Accuracy: --';
            document.getElementById('verticalSpeed').textContent = '--';
            document.getElementById('gpsAltitude').textContent = '--';
            document.getElementById('cog').textContent = '--';


            drawElevationProfile();
            map.eachLayer(function(layer){
                if(layer instanceof L.Marker) map.removeLayer(layer);
            });
            weatherInfo.innerHTML = "Loading advanced weather data...";
        };

        function updateLocation(position) {
            document.getElementById('accuracy').textContent =
                position.coords.accuracy ? position.coords.accuracy.toFixed(1) + ' m' : '--';

            if (position.coords.accuracy > ACCURACY_THRESHOLD) return;

            let lat = position.coords.latitude, lng = position.coords.longitude, elev = null;
            if (position.coords.altitude !== null) {
                elev = position.coords.altitude;
                document.getElementById('gpsAltitude').textContent = elev.toFixed(1) + ' m';

                // Vertical speed calculation
                if (lastKnownAltitude !== null && lastAltitudeTimestamp !== null) {
                    const timeDiff = (Date.now() - lastAltitudeTimestamp) / 1000; // in seconds
                    if (timeDiff > 0) {
                        const verticalDistance = elev - lastKnownAltitude;
                        const verticalSpeed = verticalDistance / timeDiff; // m/s
                        document.getElementById('verticalSpeed').textContent = verticalSpeed.toFixed(2) + ' m/s';
                    }
                }
                lastKnownAltitude = elev;
                lastAltitudeTimestamp = Date.now();
            }

            if (position.coords.speed !== null) {
                currentSpeed = position.coords.speed * 2.23694; // m/s to mph
                document.getElementById('speed').textContent = currentSpeed.toFixed(1) + ' mph';
                if (currentSpeed > maxSpeed) {
                    maxSpeed = currentSpeed;
                    document.getElementById('maxSpeed').textContent = maxSpeed.toFixed(1) + ' mph';
                }
            }

            if (position.coords.heading !== null && !isNaN(position.coords.heading)) {
                document.getElementById('cog').textContent = position.coords.heading.toFixed(0) + '°';
            } else {
                document.getElementById('cog').textContent = '--';
            }


            const now = Date.now();
            const timeDiff = (now - lastGPSTime) / 1000;
            lastGPSTime = now;

            [lat, lng] = smoothGPS(lat, lng);
            const latLng = [lat, lng];

            document.getElementById('coords').textContent = `📍 Coordinates: Latitude: ${lat.toFixed(6)}, Longitude: ${lng.toFixed(6)}`;
            fetchWeatherByCoords(lat, lng);

            if (lastLatLng) {
                const distance = getDistanceFromLatLng(lastLatLng, latLng);
                if (distance < MIN_DISTANCE || distance > MAX_DISTANCE) return;
                totalDistance += distance * 3.28084; // meters to feet
                document.getElementById('distance').textContent = 'GPS Distance: ' + totalDistance.toFixed(2) + ' ft';
            }

            trailCoordinates.push(latLng);
            if (trailLine) trailLine.setLatLngs(trailCoordinates);
            else trailLine = L.polyline(trailCoordinates, { color: '#00ffe7', weight: 4, opacity: 0.7 }).addTo(map);

            if (marker) marker.setLatLng(latLng);
            else marker = L.marker(latLng).addTo(map);
            map.setView(latLng, 15);
            lastLatLng = latLng;

            if (!baroAvailable && elev !== null) {
                elevProfile.push(elev);
                drawElevationProfile();
            }
        }

        function getDistanceFromLatLng(l1, l2) {
            const R = 6371000, toRad = v => (v * Math.PI) / 180;
            const lat1 = l1[0], lon1 = l1[1], lat2 = l2[0], lon2 = l2[1];
            const dLat = toRad(lat2 - lat1), dLon = toRad(l2[1] - l1[1]);
            const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon/2)**2;
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }
        function handleError(error) {
            switch(error.code) {
                case error.PERMISSION_DENIED: alert('Location permission denied. Please allow access for tracking.'); break;
                case error.POSITION_UNAVAILABLE: alert('Location unavailable. Check your device settings.'); break;
                case error.TIMEOUT: alert('Location request timed out. Trying again...'); break;
                default: alert('Unknown geolocation error: ' + error.message);
            }
        }

        // --- GPX Export ---
        document.getElementById('exportBtn').onclick = function() {
            if (!trailCoordinates.length) return alert("No track to export.");
            let gpx = `<?xml version="1.0" encoding="UTF-8"?>
<gpx version="1.1" creator="Alien Tech GPX Tracker v4.0" xmlns="http://www.topografix.com/GPX/1/1">
<trk><name>Alien Track</name><trkseg>
${trailCoordinates.map(([lat,lng])=>`<trkpt lat="${lat}" lon="${lng}"></trkpt>`).join('\n')}
</trkseg></trk>
${waypoints.map(wpt=>`<wpt lat="${wpt.lat}" lon="${wpt.lng}"><name>${wpt.name||'Waypoint'}</name></wpt>`).join('\n')}
</gpx>`;
            let blob = new Blob([gpx], {type:'application/gpx+xml'});
            let url = URL.createObjectURL(blob);
            let a = document.createElement('a');
            a.href = url; a.download = 'alien_track_v4.gpx'; a.click();
            URL.revokeObjectURL(url);
        };

        // --- Add Waypoint ---
        document.getElementById('addWptBtn').onclick = function() {
            if (!lastLatLng) return alert("No GPS fix yet to add a waypoint.");
            let name = prompt("Enter waypoint name:", "Waypoint " + (waypoints.length+1));
            waypoints.push({lat: lastLatLng[0], lng: lastLatLng[1], name: name});
            let customIcon = L.icon({
                iconUrl: 'https://cdn-icons-png.flaticon.com/512/684/684908.png',
                iconSize: [32, 32],
                iconAnchor: [16, 32],
                popupAnchor: [0, -32]
            });
            L.marker(lastLatLng, {icon: customIcon})
                .addTo(map).bindPopup(`<b>${name || 'Waypoint'}</b><br>Lat: ${lastLatLng[0].toFixed(4)}<br>Lon: ${lastLatLng[1].toFixed(4)}`).openPopup();
            alert(`Waypoint \"${name}\" added!`);
        };

        // --- Open in Apple Maps ---
        document.getElementById('openAppleMapsBtn').onclick = function() {
            if (!lastLatLng) {
                alert("No current GPS location to open in Apple Maps.");
                return;
            }
            const lat = lastLatLng[0];
            const lng = lastLatLng[1];
            const appleMapsUrl = `http://maps.apple.com/?ll=${lat},${lng}`;
            window.open(appleMapsUrl, '_blank');
        };

        // --- Map Style Switch ---
        document.getElementById('mapStyle').onchange = function() {
            let style = this.value;
            Object.values(mapLayers).forEach(l=>map.removeLayer(l));
            mapLayers[style].addTo(map);
        };

        // --- Map Init ---
        function initMap() {
            map = L.map('map').setView([0, 0], 2);
            mapLayers['CartoDB.Positron'].addTo(map);
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (pos) => {
                        const initialLatLng = [pos.coords.latitude, pos.coords.longitude];
                        map.setView(initialLatLng, 15);
                        L.marker(initialLatLng, {
                            icon: L.divIcon({
                                className: 'current-location-marker',
                                html: '<div style="background-color: #007aff; width: 15px; height: 15px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 5px #007aff;"></div>',
                                iconSize: [15, 15],
                                iconAnchor: [7.5, 7.5]
                            })
                        }).addTo(map)
                            .bindPopup("Your current location").openPopup();
                        fetchWeatherByCoords(pos.coords.latitude, pos.coords.longitude);
                    },
                    (err) => {
                        console.warn(`Initial location access denied or unavailable: ${err.message}`);
                    },
                    { enableHighAccuracy: true, timeout: 5000, maximumAge: 60000 }
                );
            }
        }

        // --- Initialize on Window Load ---
        window.onload = function() {
            initMap();
            drawCompass();
            drawElevationProfile();
            setupBarometer();
            setupBatteryStatus();
            document.getElementById('speed').textContent = '0.0 mph';
            document.getElementById('avgSpeed').textContent = '0.0 mph';
            document.getElementById('maxSpeed').textContent = '0.0 mph';
            document.getElementById('cog').textContent = '--';
            document.getElementById('duration').textContent = '00:00:00';
            document.getElementById('verticalSpeed').textContent = '--';
            document.getElementById('gpsAltitude').textContent = '--';
            requestAnimationFrame(updatePerformance);
        };
    </script>
</body>
</html>